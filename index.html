<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FIFO Stock Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for Inter font and general theme */
        :root {
            --primary: #3b82f6; /* blue-500 */
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* gray-100 */
        }
        .card {
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        }
        .btn-primary {
            background-color: var(--primary);
            color: white;
            transition: background-color 0.15s;
        }
        .btn-primary:hover {
            background-color: #2563eb; /* blue-600 */
        }
    </style>
</head>
<body>

    <div class="min-h-screen p-4 md:p-8">
        <header class="text-center mb-8">
            <h1 class="text-3xl font-extrabold text-gray-800">FIFO Stock Management</h1>
            <p class="text-gray-500 mt-1">First-In, First-Out Tracker for Bags/Units</p>
        </header>

        <main class="max-w-7xl mx-auto space-y-8">
            
            <div id="loading-spinner" class="text-center text-gray-500 mt-10 hidden">
                <div class="animate-spin inline-block w-8 h-8 border-4 border-t-blue-500 border-gray-200 rounded-full"></div>
                <p class="mt-2">Connecting to storage...</p>
            </div>
            
            <div id="auth-status" class="text-center text-sm mb-4">
                <p class="text-gray-400">Loading authentication status...</p>
            </div>
            <div id="error-message" class="hidden p-3 bg-red-100 border border-red-400 text-red-700 rounded-lg" role="alert"></div>

            <div id="login-card" class="max-w-md mx-auto card p-6">
                <h2 class="text-xl font-semibold mb-4 text-gray-700 text-center">üîê Login to Access Data</h2>
                <form id="login-form" class="space-y-4">
                    <div>
                        <label for="login-email" class="block text-sm font-medium text-gray-700">Email</label>
                        <input type="email" id="login-email" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="login-password" class="block text-sm font-medium text-gray-700">Password</label>
                        <input type="password" id="login-password" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <button type="submit" class="btn-primary py-2 px-4 rounded-lg font-medium" id="sign-in-btn">Sign In</button>
                        <button type="button" class="bg-gray-200 text-gray-700 py-2 px-4 rounded-lg font-medium hover:bg-gray-300 transition-colors" id="sign-up-btn">Sign Up (New User)</button>
                    </div>
                </form>
            </div>

            <div id="app-container" class="space-y-8 hidden">
                
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">

                    <div class="card p-6">
                        <h2 class="text-xl font-semibold mb-4 text-gray-700">üõí Add Purchase Bags</h2>
                        <form id="purchase-form" class="space-y-4">
                            <div>
                                <label for="bags" class="block text-sm font-medium text-gray-700">Bags Purchased</label>
                                <input type="number" id="purchase-bags" required min="1" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <div>
                                <label for="cost-per-bag" class="block text-sm font-medium text-gray-700">Cost per Bag ($)</label>
                                <input type="number" id="purchase-cost-per-bag" required min="0.01" step="0.01" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <div>
                                <label for="purchase-date" class="block text-sm font-medium text-gray-700">Purchase Date</label>
                                <input type="date" id="purchase-date" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <button type="submit" class="btn-primary w-full py-2 px-4 rounded-lg font-medium" id="purchase-submit-btn">Add Purchase</button>
                        </form>
                    </div>

                    <div class="card p-6">
                        <h2 class="text-xl font-semibold mb-4 text-gray-700">üõ†Ô∏è Log Job Usage</h2>
                        <form id="job-form" class="space-y-4">
                            <div>
                                <label for="job-bags-used" class="block text-sm font-medium text-gray-700">Bags Used</label>
                                <input type="number" id="job-bags-used" required min="1" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <div>
                                <label for="job-address" class="block text-sm font-medium text-gray-700">Job Address / Description</label>
                                <input type="text" id="job-address" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <div>
                                <label for="job-date" class="block text-sm font-medium text-gray-700">Job Date</label>
                                <input type="date" id="job-date" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <button type="submit" class="btn-primary w-full py-2 px-4 rounded-lg font-medium" id="job-submit-btn">Log Usage</button>
                        </form>
                    </div>
                </div>

                <div class="space-y-8">
                        <div class="card p-6">
                        <h2 class="text-xl font-semibold mb-4 text-gray-700">üì¶ Current Stock (FIFO)</h2>
                        <div id="current-stock-summary" class="text-lg font-bold mb-4"></div>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Purchase Date</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Original Bags</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Remaining Bags</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cost / Bag</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Value</th>
                                    </tr>
                                </thead>
                                <tbody id="current-stock-table" class="bg-white divide-y divide-gray-200">
                                    <tr><td colspan="5" class="py-4 text-center text-gray-500">No stock found. Add a purchase above.</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="card p-6">
                        <h2 class="text-xl font-semibold mb-4 text-gray-700">üìú Purchase History</h2>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Bags Bought</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cost / Bag</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total Cost</th>
                                    </tr>
                                </thead>
                                <tbody id="purchase-history-table" class="bg-white divide-y divide-gray-200">
                                    <tr><td colspan="4" class="py-4 text-center text-gray-500">No purchase history available.</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="card p-6">
                        <h2 class="text-xl font-semibold mb-4 text-gray-700">üìã Job Usage History</h2>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Bags Used</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Address/Desc</th>
                                    </tr>
                                </thead>
                                <tbody id="job-history-table" class="bg-white divide-y divide-gray-200">
                                    <tr><td colspan="3" class="py-4 text-center text-gray-500">No job history available.</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script type="module">
        // üö® UPDATED IMPORTS: Removed signInAnonymously
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getDatabase, ref, push, update, onValue, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js";

        // --- Firebase Configuration for External Hosting (GitHub) ---
        const githubFirebaseConfig = {
            apiKey: "AIzaSyCDaShKWel50m9BUdkHwZFn4hAGqLTz7K4", 
            authDomain: "esteban-tracker.firebaseapp.com", 
            databaseURL: "https://esteban-tracker-default-rtdb.firebaseio.com", 
            projectId: "esteban-tracker", 
            appId: "1:378238803870:web:1a6883e4f0379d21dcc08f", 
            storageBucket: "esteban-tracker.firebasestorage.app", 
        };

        // --- Global Variables and Firebase Setup ---
        const canvasFirebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const firebaseConfig = canvasFirebaseConfig || githubFirebaseConfig;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'github-stock-tracker';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app, rtdb, auth;
        let userId = null;
        let isAuthReady = false;
        
        // Live data state
        let purchases = [];
        let jobs = [];
        
        // Element references
        const loadingSpinner = document.getElementById('loading-spinner');
        const authStatusEl = document.getElementById('auth-status');
        const errorEl = document.getElementById('error-message');
        const appContainer = document.getElementById('app-container');
        const loginCard = document.getElementById('login-card');
        const loginForm = document.getElementById('login-form');
        const signInBtn = document.getElementById('sign-in-btn');
        const signUpBtn = document.getElementById('sign-up-btn');
        const purchaseForm = document.getElementById('purchase-form');
        const jobForm = document.getElementById('job-form');
        const purchaseSubmitBtn = document.getElementById('purchase-submit-btn');
        const jobSubmitBtn = document.getElementById('job-submit-btn');

        // Utility functions (omitted for brevity, defined in the original)
        function displayError(message) {
            console.error("App Error:", message);
            errorEl.textContent = "Error: " + message;
            errorEl.classList.remove('hidden');
        }
        function clearError() {
            errorEl.textContent = "";
            errorEl.classList.add('hidden');
        }

        const formatDate = (dateValue) => {
             if (!dateValue) return 'N/A';
             const date = new Date(dateValue + 'T12:00:00');
             return date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
        };
        const formatCurrency = (amount) => `$${amount.toFixed(2)}`;
        
        function getTodayDateString() {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0'); 
            const day = String(today.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function setInitialFormValues() {
            const todayString = getTodayDateString();
            document.getElementById('purchase-date').value = todayString;
            document.getElementById('job-date').value = todayString;
        }

        // --- UI State Management ---
        function updateUI(user) {
            clearError();
            if (user) {
                // Logged In
                userId = user.uid;
                
                const authMethod = user.email ? "Email/Password" : "Custom Token";
                
                authStatusEl.innerHTML = `
                    <p class="text-sm text-gray-600 font-medium">Signed in as: ${authMethod} User ID: ${userId.substring(0, 8)}...</p>
                    <button id="sign-out-btn" class="text-xs text-red-500 hover:text-red-700 underline mt-1">Sign Out</button>
                `;
                document.getElementById('sign-out-btn').onclick = handleSignOut;

                loginCard.classList.add('hidden');
                appContainer.classList.remove('hidden');
                isAuthReady = true;
                setupDataListeners();
            } else {
                // Logged Out
                userId = null;
                authStatusEl.innerHTML = '<p class="text-gray-400">Please sign in to access your data.</p>';
                loginCard.classList.remove('hidden');
                appContainer.classList.add('hidden');
                isAuthReady = false;
                // Clear data
                purchases = [];
                jobs = [];
                renderAllTables();
                renderJobHistory();
            }
            loadingSpinner.classList.add('hidden');
        }
        
        // --- Firebase Auth Functions ---

        async function handleEmailPasswordSignIn(e) {
            e.preventDefault();
            signInBtn.disabled = true;
            signInBtn.textContent = 'Signing In...';
            clearError();

            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;

            try {
                await signInWithEmailAndPassword(auth, email, password);
                alertModal.show("Welcome Back!", "You have successfully signed in.", 'success');
            } catch (error) {
                // Firebase error codes are often in the message, e.g., "auth/wrong-password"
                let errorMessage = error.message.includes('auth/') 
                    ? "Invalid credentials. Please check email and password." 
                    : error.message;

                displayError("Sign In Failed: " + errorMessage);
            } finally {
                signInBtn.disabled = false;
                signInBtn.textContent = 'Sign In';
            }
        }

        async function handleEmailPasswordSignUp() {
            signUpBtn.disabled = true;
            signUpBtn.textContent = 'Registering...';
            clearError();

            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;

            try {
                // Firebase automatically logs in the user after successful sign-up
                await createUserWithEmailAndPassword(auth, email, password);
                alertModal.show("Registration Successful!", "Your account has been created and you are now signed in.", 'success');
            } catch (error) {
                 let errorMessage = error.message.includes('auth/') 
                    ? "Registration failed. Password must be 6+ chars, email must be valid." 
                    : error.message;
                displayError("Sign Up Failed: " + errorMessage);
            } finally {
                signUpBtn.disabled = false;
                signUpBtn.textContent = 'Sign Up (New User)';
            }
        }

        async function handleSignOut() {
            try {
                await signOut(auth);
                alertModal.show("Signed Out", "You have been signed out.", 'info');
            } catch (error) {
                displayError("Sign Out Failed: " + error.message);
            }
        }

        // --- Firebase Initialization and Authentication ---

        function initFirebase() {
            try {
                if (!firebaseConfig || !firebaseConfig.apiKey) {
                    throw new Error("Missing Firebase Configuration.");
                }
                
                loadingSpinner.classList.remove('hidden');
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                rtdb = getDatabase(app); 
                
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        // User is signed in (Email/Password or Custom Token)
                        updateUI(user);
                    } else {
                        // User is signed out. Check for Custom Token (Canvas), otherwise show login.
                        if (initialAuthToken) {
                            try {
                                // Attempt Custom Token sign-in
                                await signInWithCustomToken(auth, initialAuthToken);
                            } catch (e) {
                                displayError("Custom token sign-in failed. Check security settings.");
                                updateUI(null); // Show login if custom token fails
                            }
                        } else {
                            // If no Custom Token and no current user, update UI to show login card
                            updateUI(null); 
                        }
                    }
                });
            } catch (e) {
                displayError("Failed to initialize Firebase: " + e.message);
                loadingSpinner.classList.add('hidden');
            }
        }

        // --- Data Listeners & Render Functions (The FIX is here in renderCurrentStock) ---

        function setupDataListeners() {
            if (!isAuthReady || !userId || !rtdb) return;

            const purchasesRef = ref(rtdb, `artifacts/${appId}/users/${userId}/purchases`);
            const jobsRef = ref(rtdb, `artifacts/${appId}/users/${userId}/jobs`);

            onValue(purchasesRef, (snapshot) => {
                const purchasesObj = snapshot.val() || {};
                
                purchases = Object.keys(purchasesObj).map(key => ({ id: key, ...purchasesObj[key] }));
                
                purchases.sort((a, b) => {
                    if (a.date < b.date) return -1;
                    if (a.date > b.date) return 1;
                    if (a.timestamp < b.timestamp) return -1;
                    if (a.timestamp > b.timestamp) return 1;
                    return 0;
                });
                
                renderAllTables();
            }, (error) => {
                displayError("Failed to fetch purchases: " + error.message);
            });

            onValue(jobsRef, (snapshot) => {
                const jobsObj = snapshot.val() || {};
                
                jobs = Object.keys(jobsObj).map(key => ({ id: key, ...jobsObj[key] }));
                jobs.sort((a, b) => b.timestamp - a.timestamp); 

                renderJobHistory();
            }, (error) => {
                displayError("Failed to fetch jobs: " + error.message);
            });
        }
        
        function renderAllTables() {
            renderPurchaseHistory();
            renderCurrentStock();
        }

        function renderPurchaseHistory() {
            const tbody = document.getElementById('purchase-history-table');
            tbody.innerHTML = '';

            if (purchases.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="py-4 text-center text-gray-500">No purchase history available.</td></tr>';
                return;
            }

            purchases.forEach(p => {
                const totalCost = p.originalBags * p.costPerBag;
                const row = `
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4 whitespace-nowrap">${formatDate(p.date)}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${p.originalBags}</td>
                        <td class="px-6 py-4 whitespace-nowrap font-mono">${formatCurrency(p.costPerBag)}</td>
                        <td class="px-6 py-4 whitespace-nowrap font-bold">${formatCurrency(totalCost)}</td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }

        function renderCurrentStock() {
            const tbody = document.getElementById('current-stock-table');
            const summaryEl = document.getElementById('current-stock-summary');
            tbody.innerHTML = '';
            
            const currentStock = purchases.filter(p => p.remainingBags > 0);
            
            let totalBagsRemaining = 0;
            let totalValue = 0;

            if (currentStock.length === 0) {
                summaryEl.textContent = "Total Remaining Bags: 0";
                tbody.innerHTML = '<tr><td colspan="5" class="py-4 text-center text-gray-500">No stock found. Add a purchase above.</td></tr>';
                return;
            }

            currentStock.forEach(p => {
                const value = p.remainingBags * p.costPerBag;
                totalBagsRemaining += p.remainingBags;
                totalValue += value;

                // üåü FIX APPLIED: Ensure formatDate(p.date) is included as the first column.
                const row = `
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4 whitespace-nowrap">${formatDate(p.date)}</td> 
                        <td class="px-6 py-4 whitespace-nowrap">${p.originalBags}</td>
                        <td class="px-6 py-4 whitespace-nowrap font-bold text-blue-600">${p.remainingBags}</td>
                        <td class="px-6 py-4 whitespace-nowrap font-mono">${formatCurrency(p.costPerBag)}</td>
                        <td class="px-6 py-4 whitespace-nowrap font-bold">${formatCurrency(value)}</td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
            
            summaryEl.textContent = `Total Remaining Bags: ${totalBagsRemaining} | Estimated Value: ${formatCurrency(totalValue)}`;
        }

        function renderJobHistory() {
            const tbody = document.getElementById('job-history-table');
            tbody.innerHTML = '';

            if (jobs.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" class="py-4 text-center text-gray-500">No job history available.</td></tr>';
                return;
            }

            jobs.forEach(j => {
                const row = `
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4 whitespace-nowrap">${formatDate(j.date)}</td>
                        <td class="px-6 py-4 whitespace-nowrap font-bold text-red-600">${j.bagsUsed}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${j.address}</td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }


        // --- Stock Management Logic (FIFO & RTDB Multi-path Update) ---
        async function processJobDeduction(bagsUsed, dateString) {
            jobSubmitBtn.disabled = true;
            jobSubmitBtn.textContent = 'Processing...';

            let remainingToDeduct = bagsUsed;
            const updates = {}; 
            const baseDataPath = `artifacts/${appId}/users/${userId}`;

            try {
                const availableStock = [...purchases].filter(p => p.remainingBags > 0);
                
                if (availableStock.length === 0) {
                    throw new Error("No stock available for deduction.");
                }

                for (const lot of availableStock) {
                    if (remainingToDeduct <= 0) break;

                    const lotPath = `${baseDataPath}/purchases/${lot.id}/remainingBags`;
                    const available = lot.remainingBags;

                    if (remainingToDeduct >= available) {
                        remainingToDeduct -= available;
                        updates[lotPath] = 0;
                    } else {
                        const newRemaining = available - remainingToDeduct;
                        updates[lotPath] = newRemaining;
                        remainingToDeduct = 0; 
                    }
                }

                if (remainingToDeduct > 0) {
                    throw new Error(`Insufficient stock. Needed ${bagsUsed} but only ${bagsUsed - remainingToDeduct} bags could be deducted.`);
                }
                
                const newJobKey = push(ref(rtdb, `${baseDataPath}/jobs`)).key;
                updates[`${baseDataPath}/jobs/${newJobKey}`] = {
                    bagsUsed: bagsUsed,
                    address: document.getElementById('job-address').value,
                    date: dateString,
                    timestamp: serverTimestamp()
                };

                await update(ref(rtdb), updates);
                
                alertModal.show("Success!", `${bagsUsed} bags were successfully used and deducted following FIFO.`, 'success');

            } catch (error) {
                if (error.message.includes("Insufficient stock")) {
                    alertModal.show("Deduction Failed", error.message, 'error');
                } else {
                    displayError("Deduction Failed: " + error.message);
                    alertModal.show("Deduction Failed", `An unexpected error occurred: ${error.message}`, 'error');
                }
            } finally {
                jobSubmitBtn.disabled = false;
                jobSubmitBtn.textContent = 'Log Usage';
            }
        }


        // --- Form Submission Handlers ---

        loginForm.addEventListener('submit', handleEmailPasswordSignIn);
        signUpBtn.addEventListener('click', handleEmailPasswordSignUp);

        purchaseForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!isAuthReady || !userId) return displayError("App not ready. Please wait for authentication.");

            const bags = parseInt(document.getElementById('purchase-bags').value);
            const costPerBag = parseFloat(document.getElementById('purchase-cost-per-bag').value);
            const dateString = document.getElementById('purchase-date').value;
            
            if (bags <= 0 || costPerBag <= 0 || !dateString) {
                return displayError("Please enter valid purchase details.");
            }

            const purchasesRef = ref(rtdb, `artifacts/${appId}/users/${userId}/purchases`);

            purchaseSubmitBtn.disabled = true;
            purchaseSubmitBtn.textContent = 'Adding...';

            try {
                await push(purchasesRef, {
                    originalBags: bags,
                    remainingBags: bags,
                    costPerBag: costPerBag,
                    date: dateString, 
                    timestamp: serverTimestamp() 
                });
                purchaseForm.reset();
                setInitialFormValues();
                alertModal.show("Success!", `Added ${bags} bags at ${formatCurrency(costPerBag)} per bag.`, 'success');
            } catch (error) {
                displayError("Failed to add purchase: " + error.message);
            } finally {
                purchaseSubmitBtn.disabled = false;
                purchaseSubmitBtn.textContent = 'Add Purchase';
            }
        });

        jobForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!isAuthReady || !userId) return displayError("App not ready. Please wait for authentication.");

            const bagsUsed = parseInt(document.getElementById('job-bags-used').value);
            const address = document.getElementById('job-address').value.trim();
            const dateString = document.getElementById('job-date').value;
            
            if (bagsUsed <= 0 || !address || !dateString) {
                return displayError("Please enter valid job usage details.");
            }
            
            const totalRemaining = purchases.reduce((sum, p) => sum + p.remainingBags, 0);
            if (bagsUsed > totalRemaining) {
                 alertModal.show("Stock Warning", `Cannot use ${bagsUsed} bags. Only ${totalRemaining} bags are currently in stock.`, 'warning');
                 return;
            }

            await processJobDeduction(bagsUsed, dateString);
            jobForm.reset();
            setInitialFormValues();
        });

        // --- Custom Alert Modal (Remains the same) ---

        const alertModal = (function() {
            const modalHtml = `
                <div id="custom-modal" class="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center z-50 hidden">
                    <div class="card p-6 w-96 max-w-lg space-y-4">
                        <div id="modal-icon" class="text-4xl text-center"></div>
                        <h3 id="modal-title" class="text-xl font-bold text-center text-gray-800"></h3>
                        <p id="modal-body" class="text-gray-600 text-center"></p>
                        <button id="modal-close-btn" class="btn-primary w-full py-2 rounded-lg font-medium">OK</button>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHtml);

            const modal = document.getElementById('custom-modal');
            const titleEl = document.getElementById('modal-title');
            const bodyEl = document.getElementById('modal-body');
            const iconEl = document.getElementById('modal-icon');
            const closeBtn = document.getElementById('modal-close-btn');

            closeBtn.onclick = () => modal.classList.add('hidden');

            function show(title, body, type = 'info') {
                titleEl.textContent = title;
                bodyEl.textContent = body;
                iconEl.innerHTML = ''; 
                
                let iconText = '';
                switch (type) {
                    case 'success': iconText = '<span class="text-green-500">üéâ</span>'; break;
                    case 'error': iconText = '<span class="text-red-500">üõë</span>'; break;
                    case 'warning': iconText = '<span class="text-yellow-500">‚ö†Ô∏è</span>'; break;
                    default: iconText = '<span class="text-blue-500">‚ÑπÔ∏è</span>';
                }
                iconEl.innerHTML = iconText;
                
                modal.classList.remove('hidden');
            }

            return { show };
        })();


        // --- Start Application ---
        window.onload = () => {
            initFirebase();
            setInitialFormValues(); 
        };

    </script>
</body>
</html>

