<!DOCTYPE html>
<html lang="en">
<head>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Esteban INSULATION FIFO Tracker</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>

  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
    import { getFirestore, enableIndexedDbPersistence, collection, doc, setDoc, deleteDoc, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCa9VjE4S3X9Bepfj8X713SVZCdsDht1Kw",
      authDomain: "esteban-fifo-tracker.firebaseapp.com",
      projectId: "esteban-fifo-tracker",
      storageBucket: "esteban-fifo-tracker.firebasestorage.app",
      messagingSenderId: "1002389930378",
      appId: "1:1002389930378:web:177a8b461c9d870e520873",
      measurementId: "G-17GN7KQTDE"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    enableIndexedDbPersistence(db).catch(() => {});

    window.db = db;
    window.doc = doc;
    window.setDoc = setDoc;
    window.deleteDoc = deleteDoc;
    window.collection = collection;
    window.onSnapshot = onSnapshot;
    window.serverTimestamp = serverTimestamp;
  </script>

  <style>
    body { font-family: system-ui, sans-serif; background: linear-gradient(to bottom, #eef2ff, #e0e7ff); min-height: 100vh; }
    .container { max-width: 560px; }
    .scrollable { max-height: 400px; overflow-y: auto; }
    .batch-card:hover { transform: translateY(-2px); transition: all 0.2s; }
  </style>
</head>
<body class="p-4 pb-20">

<div class="container mx-auto space-y-6">
  <header class="text-center py-8 bg-white rounded-3xl shadow-xl">
    <h1 class="text-5xl font-extrabold">
      <span class="text-indigo-700">Esteban</span>
      <span class="text-red-600 block text-4xl font-bold uppercase mt-2">INSULATION</span>
    </h1>
    <p class="text-gray-600 mt-3 text-lg">FIFO Tracker • Cloud Sync • Works Offline</p>
  </header>

  <div id="sync-message" class="text-center font-bold text-green-600 text-xl"></div>

  <div id="metrics" class="grid grid-cols-3 gap-4"></div>

  <!-- Add Purchase -->
  <div class="bg-white p-6 rounded-2xl shadow-2xl">
    <h2 class="text-2xl font-bold mb-5">Add Purchase Batch</h2>
    <form id="add-form" class="grid grid-cols-2 gap-4">
      <div class="col-span-2">
        <label>Purchase Date</label>
        <input type="date" id="purchase-date" required class="w-full p-3 border rounded-lg"/>
      </div>
      <div><label>Bags</label><input type="number" id="bags" required min="1" placeholder="50" class="w-full p-3 border rounded-lg"/></div>
      <div><label>Cost per Bag ($)</label><input type="number" id="cost" required min="0.01" step="0.01" placeholder="5.50" class="w-full p-3 border rounded-lg"/></div>
      <button type="submit" class="col-span-2 bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-4 rounded-xl text-lg">Add to Inventory</button>
    </form>
  </div>

  <!-- Log Job -->
  <div class="bg-white p-6 rounded-2xl shadow-2xl">
    <h2 class="text-2xl font-bold mb-5">Log Job Usage</h2>
    <form id="job-form" class="space-y-4">
      <input type="date" id="job-date" required class="w-full p-3 border rounded-lg"/>
      <input type="text" id="job-address" required placeholder="Address" class="w-full p-3 border rounded-lg"/>
      <div>
        <input type="number" id="job-bags" required min="1" placeholder="Bags used" class="w-full p-3 border rounded-lg"/>
        <p id="available-text" class="text-sm text-gray-600 mt-1">Available: 0 bags</p>
      </div>
      <button type="submit" id="job-btn" disabled class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-4 rounded-xl disabled:opacity-50">
        Deduct Bags & Log Job
      </button>
    </form>
  </div>

  <!-- Current Stock -->
  <div class="bg-white p-6 rounded-2xl shadow-2xl">
    <div class="flex justify-between items-center mb-4">
      <h2 class="text-2xl font-bold">Current Stock</h2>
      <span id="total-badge" class="bg-indigo-100 text-indigo-800 px-4 py-2 rounded-full font-bold text-lg">0 bags</span>
    </div>
    <div id="stock-list" class="scrollable space-y-3"></div>
  </div>

  <div class="bg-white p-6 rounded-2xl shadow-2xl">
    <h2 class="text-2xl font-bold mb-4">Purchase History</h2>
    <div id="purchase-list" class="scrollable space-y-3"></div>
  </div>

  <div class="bg-white p-6 rounded-2xl shadow-2xl">
    <h2 class="text-2xl font-bold mb-4">Job History</h2>
    <div id="job-list" class="scrollable space-y-3"></div>
  </div>
</div>

<script type="module">
  let data = { inventory: [], purchases: [], jobs: [] };
  const today = new Date().toISOString().split('T')[0];

  // Wait for page to load before touching inputs
  document.addEventListener('DOMContentLoaded', () => {
    document.getElementById('purchase-date').value = today;
    document.getElementById('job-date').value = today;
  });

  // Load local backup
  const saved = localStorage.getItem('esteban-data');
  if (saved) data = JSON.parse(saved);

  // Real-time sync
  const q = collection(db, "esteban");
  onSnapshot(q, (snap) => {
    data = { inventory: [], purchases: [], jobs: [] };
    snap.forEach(d => {
      const item = { id: d.id, ...d.data() };
      if (item.type === "purchase") {
        data.purchases.push(item);
        data.inventory.push(item);
      } else if (item.type === "job") data.jobs.push(item);
    });
    data.inventory.sort((a,b) => a.date.localeCompare(b.date));
    localStorage.setItem('esteban-data', JSON.stringify(data));
    render();
  });

  function render() {
    const totalBags = data.inventory.reduce((s,b) => s + b.qty, 0);
    const totalValue = data.inventory.reduce((s,b) => s + b.qty * b.cost, 0).toFixed(2);
    const totalCOGS = data.jobs.reduce((s,j) => s + (j.cogs || 0), 0).toFixed(2);

    document.getElementById('metrics').innerHTML = `
      <div class="bg-white p-5 rounded-xl shadow text-center border-b-4 border-indigo-600">
        <p class="text-gray-600 text-sm">Bags in Stock</p>
        <p class="text-4xl font-extrabold text-indigo-700">${totalBags}</p>
      </div>
      <div class="bg-white p-5 rounded-xl shadow text-center border-b-4 border-amber-500">
        <p class="text-gray-600 text-sm">Inventory Value</p>
        <p class="text-4xl font-extrabold text-amber-600">$${totalValue}</p>
      </div>
      <div class="bg-white p-5 rounded-xl shadow text-center border-b-4 border-green-600">
        <p class="text-gray-600 text-sm">Total COGS</p>
        <p class="text-4xl font-extrabold text-green-700">$${totalCOGS}</p>
      </div>
    `;

    document.getElementById('available-text').textContent = `Available: ${totalBags} bags`;
    document.getElementById('total-badge').textContent = `${totalBags} bags`;
    document.getElementById('job-btn').disabled = totalBags === 0;

    document.getElementById('stock-list').innerHTML = data.inventory.length === 0 ?
      '<p class="text-center text-gray-500 py-8">No stock</p>' :
      data.inventory.map((b,i) => `
        <div class="batch-card p-4 rounded-lg ${i===0?'bg-red-50 border-red-400':'bg-gray-50'} border-l-4">
          <p class="font-bold">${b.qty} bags @ $${b.cost.toFixed(2)}/bag</p>
          <p class="text-sm text-gray-600">${new Date(b.date).toLocaleDateString()} • $${(b.qty*b.cost).toFixed(2)}</p>
          ${i===0 ? '<span class="text-xs bg-red-600 text-white px-2 py-1 rounded mt-2 inline-block">Next Out (FIFO)</span>' : ''}
        </div>
      `).join('');

    document.getElementById('purchase-list').innerHTML = data.purchases.length === 0 ?
      '<p class="text-center text-gray-500 py-8">No purchases yet</p>' :
      data.purchases.slice().reverse().map(p => `
        <div class="p-4 bg-purple-50 rounded-lg border-l-4 border-purple-500">
          <p class="font-bold">${p.qty} bags @ $${p.cost.toFixed(2)} • ${new Date(p.date).toLocaleDateString()}</p>
        </div>
      `).join('');

    document.getElementById('job-list').innerHTML = data.jobs.length === 0 ?
      '<p class="text-center text-gray-500 py-8">No jobs yet</p>' :
      data.jobs.slice().reverse().map(j => `
        <div class="p-4 bg-green-50 rounded-lg border-l-4 border-green-500">
          <p class="font-bold">${j.address}</p>
          <p class="text-sm text-gray-600">${new Date(j.date).toLocaleDateString()} • ${j.bags} bags • COGS $${(j.cogs||0).toFixed(2)}</p>
        </div>
      `).join('');
  }

  // ADD PURCHASE — WORKS 100%
  document.getElementById('add-form').onsubmit = async e => {
    e.preventDefault();
    const id = Date.now().toString();
    const batch = {
      type: "purchase",
      date: document.getElementById('purchase-date').value,
      qty: +document.getElementById('bags').value,
      cost: +document.getElementById('cost').value
    };
    await setDoc(doc(db, "esteban", id), batch);
    document.getElementById('sync-message').textContent = "Added & Synced!";
    setTimeout(() => document.getElementById('sync-message').textContent = "", 3000);
    e.target.reset();
    document.getElementById('purchase-date').value = today;
  };

  // LOG JOB — WORKS 100%
  document.getElementById('job-form').onsubmit = async e => {
    e.preventDefault();
    const needed = +document.getElementById('job-bags').value;
    let remaining = needed;
    let cost = 0;
    const newInv = [];
    const sorted = [...data.inventory].sort((a,b) => a.date.localeCompare(b.date));

    for (const batch of sorted) {
      if (remaining <= 0) { newInv.push(batch); continue; }
      if (batch.qty >= remaining) {
        cost += remaining * batch.cost;
        if (batch.qty > remaining) newInv.push({ ...batch, qty: batch.qty - remaining });
        remaining = 0;
      } else {
        cost += batch.qty * batch.cost;
        remaining -= batch.qty;
      }
    }
    if (remaining > 0) return alert("Not enough bags!");

    // Delete old, save new
    for (const old of data.inventory) await deleteDoc(doc(db, "esteban", old.id));
    for (const upd of newInv) await setDoc(doc(db, "esteban", upd.id), upd);
    const jobId = Date.now().toString();
    await setDoc(doc(db, "esteban", jobId), {
      type: "job",
      date: document.getElementById('job-date').value,
      address: document.getElementById('job-address').value,
      bags: needed,
      cogs: +cost.toFixed(2)
    });

    document.getElementById('sync-message').textContent = "Job Logged!";
    setTimeout(() => document.getElementById('sync-message').textContent = "", 3000);
    e.target.reset();
    document.getElementById('job-date').value = today;
  };

  render();
  lucide.createIcons();
</script>
</body>
</html>
