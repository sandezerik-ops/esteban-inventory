<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Esteban INSULATION FIFO Tracker</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <style>
    body { font-family: system-ui, sans-serif; background: #f3f4f6; }
    .container { max-width: 520px; }
    .scrollable-list { max-height: 340px; overflow-y: auto; }
  </style>
</head>
<body class="min-h-screen p-4">

<div class="container mx-auto space-y-6 max-w-lg">
  <header class="text-center py-8">
    <h1 class="text-5xl font-extrabold">
      <span class="text-indigo-700">Esteban</span>
      <span class="text-red-600 block text-3xl font-bold tracking-widest uppercase mt-2">INSULATION</span>
    </h1>
    <p class="text-gray-600 mt-2">FIFO Tracker • Google Drive Sync • No Account</p>
  </header>

  <!-- Sync Controls -->
  <div class="bg-white p-6 rounded-2xl shadow-2xl">
    <h2 class="text-xl font-bold mb-4 flex items-center">
      <i data-lucide="cloud" class="w-7 h-7 mr-3 text-blue-600"></i> Google Drive Sync
    </h2>
    <div id="sync-message" class="mb-4"></div>
    <div class="flex gap-3">
      <button id="auth-btn" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-xl">
        Connect to Drive
      </button>
      <button id="download-btn" disabled class="flex-1 bg-green-600 opacity-50 text-white font-bold py-3 rounded-xl">
        Download
      </button>
      <button id="upload-btn" disabled class="flex-1 bg-indigo-600 opacity-50 text-white font-bold py-3 rounded-xl">
        Upload
      </button>
    </div>
    <p class="text-xs text-gray-500 mt-3">File: <code>esteban-data.json</code> (root of your Drive)</p>
  </div>

  <!-- Danger Zone - Reset Everything -->
  <div class="bg-red-50 border border-red-300 p-6 rounded-2xl">
    <button id="reset-all-btn" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-4 rounded-xl">
      DELETE ALL DATA & START OVER
    </button>
    <p class="text-xs text-red-700 mt-2 text-center">Deletes everything locally + on Google Drive</p>
  </div>

  <!-- Rest of your UI (unchanged) -->
  <div id="metrics-container" class="grid grid-cols-3 gap-4"></div>
  <!-- Add Stock, Log Job, Current Stock, Job History — same as before -->
  <!-- (I kept them exactly the same, just omitted here to keep the answer short) -->

</div>

<!-- Google APIs -->
<script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
<script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>

<script type="module">
  // PUT YOUR REAL KEYS HERE
  const CLIENT_ID = '944856782006-ubq8bp6dahulmc4092rh7cusbbl0lch6.apps.googleusercontent.com';
  const API_KEY = 'AIzaSyC4RFRkURLHS_p_TFgkLuWRKBnABKUIU9o';

  const DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest';
  const SCOPES = 'https://www.googleapis.com/auth/drive.file';

  let tokenClient;
  let gapiInited = false;
  let gisInited = false;
  let fileId = null;

  function gapiLoaded() {
    gapi.load('client', async () => {
      await gapi.client.init({
        apiKey: API_KEY,
        discoveryDocs: [DISCOVERY_DOC],
      });
      gapiInited = true;
      maybeEnableButtons();
    });
  }

  function gisLoaded() {
    tokenClient = google.accounts.oauth2.initTokenClient({
      client_id: CLIENT_ID,
      scope: SCOPES,
      callback: (resp) => {
        if (resp.error) {
          showMessage('Auth failed: ' + resp.error, 'error');
          return;
        }
        gisInited = true;
        document.getElementById('auth-btn').textContent = 'Authenticated ✓';
        document.getElementById('auth-btn').disabled = true;
        document.getElementById('auth-btn').classList.replace('bg-blue-600', 'bg-gray-600');
        enableSyncButtons();
        findOrCreateFile();
      },
    });
    gisInited = true;
    maybeEnableButtons();
  }

  function maybeEnableButtons() {
    if (gapiInited && gisInited) {
      document.getElementById('auth-btn').onclick = () => tokenClient.requestAccessToken({prompt: 'consent'});
    }
  }

  function enableSyncButtons() {
    document.getElementById('download-btn').disabled = false;
    document.getElementById('download-btn').classList.remove('opacity-50');
    document.getElementById('upload-btn').disabled = false;
    document.getElementById('upload-btn').classList.remove('opacity-50');
    document.getElementById('download-btn').onclick = downloadData;
    document.getElementById('upload-btn').onclick = uploadData;
  }

  // === REST OF THE CODE (unchanged) ===
  // findOrCreateFile, downloadData, uploadData, showMessage, localData, FIFO, renderAll, forms, etc.
  // I’m pasting only the fixed parts above + the reset button below

  async function findOrCreateFile() {
    try {
      const res = await gapi.client.drive.files.list({
        q: "name='esteban-data.json' and mimeType='application/json' and trashed=false",
        fields: 'files(id,name)'
      });
      if (res.result.files?.length > 0) {
        fileId = res.result.files[0].id;
        showMessage('Found esteban-data.json', 'success');
        downloadData();
      } else {
        const fileMetadata = { name: 'esteban-data.json', mimeType: 'application/json' };
        const res = await gapi.client.drive.files.create({
          resource: fileMetadata,
          media: { mimeType: 'application/json', body: JSON.stringify({inventory:[],jobs:[]},null,2) },
          fields: 'id'
        });
        fileId = res.result.id;
        showMessage('Created new esteban-data.json', 'success');
      }
    } catch (e) { showMessage('Drive error: '+e.message, 'error'); }
  }

  async function downloadData() {
    if (!fileId) return;
    try {
      const res = await gapi.client.drive.files.get({fileId, alt:'media'});
      loadData(JSON.parse(res.body));
      showMessage('Data downloaded', 'success');
    } catch (e) { showMessage('Download failed', 'error'); }
  }

  async function uploadData() {
    if (!fileId) return;
    const data = getCurrentData();
    try {
      await gapi.client.drive.files.update({
        fileId,
        resource: {mimeType:'application/json'},
        media: {mimeType:'application/json', body:JSON.stringify(data,null,2)}
      });
      showMessage('Uploaded to Drive', 'success');
    } catch (e) { showMessage('Upload failed', 'error'); }
  }

  function showMessage(text, type='info') {
    const div = document.getElementById('sync-message');
    div.innerHTML = `<div class="p-3 rounded ${type==='success'?'bg-green-100 text-green-700':type==='error'?'bg-red-100 text-red-700':'bg-blue-100 text-blue-700'}">${text}</div>`;
    setTimeout(()=>div.innerHTML='', 4000);
  }

  // === DANGER: FULL RESET BUTTON ===
  document.getElementById('reset-all-btn').onclick = async () => {
    if (!confirm('Delete EVERYTHING forever?')) return;
    if (!confirm('Last chance!')) return;

    localData = {inventory: [], jobs: []};
    localStorage.removeItem('esteban-local');
    renderAll();
    showMessage('Local data cleared', 'success');

    if (fileId && gapi.client?.drive) {
      try {
        await gapi.client.drive.files.update({
          fileId,
          resource: {mimeType:'application/json'},
          media: {mimeType:'application/json', body:JSON.stringify({inventory:[],jobs:[]},null,2)}
        });
        showMessage('Google Drive file also reset!', 'success');
      } catch(e) {
        showMessage('Drive reset failed', 'error');
      }
    }
  };

  // Your existing localData, loadData, getCurrentData, consumeFifo, renderAll, forms, etc.
  // (copy everything from your original script — it all works fine)

  // ... [paste the rest of your original <script> code here — everything from let localData = ... to the end]

</script>
</body>
</html>
